<p align="center"><a href="https://cloudinary.com" target="_blank">			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 96.77" width="500" height="97" fill="blue">
				<path
					d="M160.53 30.41a17.14 17.14 0 0 1 13.56 6.7.69.69 0 0 0 1 .11l5.71-4.55a.71.71 0 0 0 .11-1 26 26 0 0 0-20.61-10.13c-14.91 0-27 12.85-27 28.65s12.13 28.65 27 28.65a25.85 25.85 0 0 0 20.6-10.12.69.69 0 0 0-.12-1l-5.7-4.5a.71.71 0 0 0-1 .11A17.26 17.26 0 0 1 160.53 70c-10.19 0-18.16-8.7-18.16-19.79s7.97-19.8 18.16-19.8ZM188.27 19.91h7.16a.71.71 0 0 1 .71.71V77.4a.7.7 0 0 1-.7.7h-7.16a.71.71 0 0 1-.71-.71V20.62a.7.7 0 0 1 .7-.71ZM220.54 39.55c-9.49 0-19.09 6.72-19.09 19.57 0 11.29 8.21 19.81 19.09 19.81s19.17-8.52 19.17-19.81-8.24-19.57-19.17-19.57Zm10.53 19.57c0 6.52-4.53 11.44-10.53 11.44s-10.44-4.92-10.44-11.44 4.49-11.2 10.44-11.2 10.53 4.81 10.53 11.2ZM278.3 40.37h-7.16a.7.7 0 0 0-.71.7v19c0 7.42-5.12 10.05-9.51 10.05-3.88 0-7.79-2.93-7.79-9.48V41.07a.7.7 0 0 0-.71-.7h-7.16a.7.7 0 0 0-.7.7v20.5c0 11.25 5.09 17.44 14.34 17.44 3.36 0 8.8-1.93 10.84-6.19l.69.14v4.44a.71.71 0 0 0 .71.71h7.16a.71.71 0 0 0 .71-.71V41.07a.7.7 0 0 0-.71-.7ZM322.27 19.91h-7.17a.7.7 0 0 0-.7.71V46l-.44-.7c-2.18-3.51-6.87-5.78-11.95-5.78-8.76 0-17.62 6.75-17.62 19.65 0 11.25 7.61 19.73 17.69 19.73 3.84 0 9.25-1.54 11.88-5.86l.44-.72v5.08a.7.7 0 0 0 .7.71h7.17a.7.7 0 0 0 .7-.71V20.62a.7.7 0 0 0-.7-.71Zm-8 39.21a11 11 0 0 1-10.75 11.36c-5.86 0-10.45-5-10.45-11.36s4.59-11.2 10.45-11.2a11 11 0 0 1 10.72 11.2ZM333 40.37h7.16a.7.7 0 0 1 .7.7V77.4a.7.7 0 0 1-.7.7H333a.71.71 0 0 1-.71-.71V41.07a.71.71 0 0 1 .71-.7ZM336.61 21.06a5.57 5.57 0 0 0-5.69 5.57 5.64 5.64 0 0 0 5.69 5.58 5.54 5.54 0 0 0 5.61-5.58 5.48 5.48 0 0 0-5.61-5.57ZM370.35 39.55c-3.14 0-8.72 1.69-10.85 6.19l-.69-.14v-4.53a.7.7 0 0 0-.71-.7h-7.16a.7.7 0 0 0-.7.7V77.4a.7.7 0 0 0 .7.71h7.16a.71.71 0 0 0 .71-.71v-19c0-7.36 5.12-10 9.51-10 3.88 0 7.79 2.91 7.79 9.4v19.6a.71.71 0 0 0 .71.71H384a.71.71 0 0 0 .71-.71V56.91c-.02-11.19-5.12-17.36-14.36-17.36ZM427.48 40.37h-7.16a.7.7 0 0 0-.71.7v5l-.43-.7c-2.19-3.51-6.88-5.78-12-5.78-8.75 0-17.62 6.75-17.62 19.65 0 11.25 7.61 19.73 17.7 19.73 3.83 0 9.24-1.54 11.88-5.86l.43-.72v5.01a.71.71 0 0 0 .71.71h7.16a.7.7 0 0 0 .7-.71V41.07a.7.7 0 0 0-.66-.7Zm-8 18.75a11 11 0 0 1-10.78 11.36c-5.86 0-10.44-5-10.44-11.36s4.58-11.2 10.44-11.2a11 11 0 0 1 10.76 11.2ZM460.15 40.5a13.66 13.66 0 0 0-5.14-1c-4.76 0-8.22 2.85-10 8.25l-.64-.09v-6.59a.7.7 0 0 0-.71-.7h-7.16a.7.7 0 0 0-.71.7V77.4a.71.71 0 0 0 .71.71h7.24a.7.7 0 0 0 .7-.71V65c0-14.8 5.91-17 9.44-17a11 11 0 0 1 4.33.9.72.72 0 0 0 .61 0 .7.7 0 0 0 .36-.48l1.42-7.11a.71.71 0 0 0-.45-.81ZM499.88 40.68a.69.69 0 0 0-.59-.31h-7.71a.72.72 0 0 0-.66.45L481.59 65l-9.42-24.18a.72.72 0 0 0-.66-.45h-7.86a.69.69 0 0 0-.58.31.7.7 0 0 0-.07.66l14 34.38-7.73 20.09a.71.71 0 0 0 .66 1h7.5a.69.69 0 0 0 .65-.45l21.86-55a.69.69 0 0 0-.06-.68ZM97.91 28.11A40.38 40.38 0 0 0 59.73 0 39.62 39.62 0 0 0 24.6 20.87a29.88 29.88 0 0 0-7.21 56.56l.75.34h.05v-8.5a22.29 22.29 0 0 1 9.29-41.16l2.1-.22.92-1.89A32.15 32.15 0 0 1 59.73 7.57a32.7 32.7 0 0 1 31.55 25l.72 2.86h3a18.53 18.53 0 0 1 18.15 18.46c0 7.05-4.07 12.82-11 15.74v8.06l.5-.16c11.14-3.65 18.06-12.71 18.06-23.64a26.19 26.19 0 0 0-22.8-25.78Z"></path>
				<path
					d="m45.07 76.79 1.66 1.66a.33.33 0 0 1-.23.56H33.4a6 6 0 0 1-6-6V47.57a.33.33 0 0 0-.33-.33h-2.8a.33.33 0 0 1-.24-.56l11.12-11.12a.33.33 0 0 1 .47 0l11.11 11.12a.33.33 0 0 1-.23.56h-2.84a.34.34 0 0 0-.34.33v25a6 6 0 0 0 1.75 4.22ZM69.64 76.79l1.67 1.66a.33.33 0 0 1-.24.56H58a6 6 0 0 1-6-6V54a.34.34 0 0 0-.33-.34h-2.83a.33.33 0 0 1-.23-.56L59.72 42a.33.33 0 0 1 .47 0l11.12 11.08a.33.33 0 0 1-.24.56h-2.84a.34.34 0 0 0-.33.34v18.59a6 6 0 0 0 1.74 4.22ZM94.22 76.79l1.66 1.66a.33.33 0 0 1-.23.56H82.54a6 6 0 0 1-6-6V60.38a.33.33 0 0 0-.33-.33h-2.8a.33.33 0 0 1-.23-.57L84.3 48.37a.32.32 0 0 1 .46 0l11.12 11.11a.33.33 0 0 1-.23.57H92.8a.33.33 0 0 0-.33.33v12.19a6 6 0 0 0 1.75 4.22Z"></path>
			</svg>
</a></p>

<h1 align="center">
 Video Moderation with Cloudinary
</h1>

Cloudinary is a Software-as-a-Service (SaaS) solution for managing all your web or mobile application’s media assets in
the cloud. Cloudinary offers an end-to-end solution for all your image and video needs, including upload, storage,
administration, transformation and optimized delivery.

Laravel is a PHP framework developed with developer productivity in mind. The framework also aims to evolve with the web and has already incorporated several new features and ideas in the web development world—such as job queues, **API authentication** out of the box, real-time communication, and much more.

## Introduction

Video moderation helps you share highly engaging and effective video content while protecting your brand, customers and profits. We will create a simple automated video moderation platform that will help us filter out offensive videos.

Let's get started.

## Github

The entire source code is available on my [Github](https://github.com/victorokech/cloudinary-video-mod) repository.

## Prerequisites

Using Cloudinary in your Laravel projects is pretty straightforward. However, for you to be able to easily follow along,
you need to have a good command of your terminal, Git and entry knowledge of PHP specifically with the Laravel
framework.

## Getting Started

Being that Laravel is a PHP Framework, we will need Composer. Like any modern PHP framework, Laravel uses Composer to manage its dependencies. So, before we can
start ensure you have Composer installed on your machine. Follow step 1 below to install Composer and PHP.

1. Install [Composer](https://getcomposer.org/) and [PHP](https://www.php.net/manual/en/install.windows.tools.php) on
   your development or production machine.
2. Install Laravel
   
   a) Via Composer:
   
   `composer create-project --prefer-dist laravel/laravel cloudinary-video-slideshow`
   b) Via Laravel Installer
   
   `composer global require laravel/installer`
   
   `laravel new cloudinary-video-slideshow`
3. In step 2 above we have installed the Laravel Installer and used it to scaffold a new application in the folder `cloudinary-video-slideshow`. With Laravel installed, we should be able to start and test the server ensuring everything is okay. Change the directory to the project folder and run the local development server by typing the following commands:
   
   `cd cloudinary-video-slideshow`
   
   `php artisan serve`

The Laravel project is now up and running. When you open `http://localhost:8000` on your computer, you should see the image below:

![Laravel Server Running](https://res.cloudinary.com/dgrpkngjn/image/upload/v1655887283/watermark-api/assets/laravel-running_zqk8ol.png)

## Setting up Cloudinary’s Laravel SDK

Cloudinary has a tonne of features from media upload, storage, administration, and manipulation to optimization and delivery. In this article, we will use Cloudinary Video Transformations to combine existing or newly uploaded media files to create a slideshow.

1. Sign up for a free Cloudinary account then navigate to the Console page and take note of your Cloud name, API Key and API Secret.
   ![Cloudinary Dashboard](https://res.cloudinary.com/dgrpkngjn/image/upload/v1655976836/assets/cloudinary_dashboard.png)
2. Google AI Video Moderation Addon - while at the Cloudinary dashboard, click on the Addons menu and subscribe for the Google AI Video Moderation Addon.
   ![Cloudinary Addons](https://res.cloudinary.com/dgrpkngjn/image/upload/v1656844100/video-mod/assets/cloudinary_addons_z9ovwn.png)
   
   ![Cloudinary Google AI Video Moderation Subscription](https://res.cloudinary.com/dgrpkngjn/image/upload/v1656844100/video-mod/assets/cloudinary_ai_subscription_eqaqkd.png)
3. Install [Cloudinary’s Laravel SDK](https://github.com/cloudinary-labs/cloudinary-laravel#installation):
   
   `composer require cloudinary-labs/cloudinary-laravel`

**Note**: Please ensure you follow all the steps in the #Installation section. Publish the configuration file and add
the Cloudinary credentials you noted in Step 1 to the `.env` file.

```
CLOUDINARY_API_KEY=YOUR_CLOUDINARY_API_KEY
CLOUDINARY_API_SECRET=YOUR_CLOUDINARY_API_SECRET
CLOUDINARY_CLOUD_NAME=YOUR_CLOUDINARY_CLOUD_NAME
```

## Cloudinary Video Moderation

Cloudinary employs two addons for video moderation:

1. Rekognition AI Video Moderaion by AWS
2. Google AI Video Moderation

Google assigns a moderation confidence level indicating the chances that a video contains unacceptable content. The likelihood is given as a value on the following scale: `very_unlikely`, `unlikely`, `possible`, `likely`, and `very_likely`.

To send a request for Google AI Video Moderation with the default rejection confidence level we need to set the `moderation` parameter to `google_video_moderation` and set the `resource_type` to `video`:

`$cloudinary->uploadApi()->upload("my_file.mp4", [ "resource_type" => "video", "moderation" => "google_video_moderation"]);`

Let's see this in code.

## File Upload with Livewire

To uplaod a video for moderation we will need a UI (User Interface), we will use the Laravel package Livewire to build this.

1. Install Livewire Package by running the following command in your Laravel project:
   
   `composer require livewire/livewire`
2. Include Livewire scripts and styles on every page that will be using Livewire. In our case `welcome.blade.php`:

```html
...
    @livewireStyles
</head>
<body>
    ...
  
    @livewireScripts
</body>
</html>
```

3. We will then create a Livewire Component to handle our image uploads:
   
   `php artisan make:livewire FileUpload`

This will create two files, first `app/Http/Livewire/FileUpload.php` and the other one
in `resources/views/livewire/multiple-file-upload.blade.php`

Now you can use this component anywhere in your Laravel project using the following snippet:

`<livewire:file-upload/>`

or

`@livewire('file-upload')`

3. Open `resources/views/welcome.blade.php` and add the following code within the `<body></body>` tags as shown below:

```html
<body class="antialiased">
  <div>
    @livewire('file-upload')
  </div>
</body>
```

This includes the Livewire component we created earlier in our `welcome.blade.php`.

**Note:** Please ensure you go through the [Livewire documentation](https://laravel-livewire.com/docs/2.x/quickstart), to learn how to install and set it up.

3. Open the file `resources/views/livewire/multiple-file-upload.blade.php` and populate it with the following code:

```html
<form class="mb-5" wire:submit.prevent="uploadVideo">
  <div class="form-group row mt-5 mb-3">
    <div class="input-group">
      <input id="video" type="file" class="form-control @error('video') is-invalid @enderror" wire:model="video">
	@error('video')
		<div class="invalid-feedback">{{ $message }}</div>
	@enderror
	</div>
	<small class="text-muted text-center mt-2" wire:loading wire:target="video">
		{{ __('Uploading') }}…
	</small>
	</div>
	<div class="text-center">
		<button type="submit" class="btn btn-sm btn-primary">
			{{ __('Upload Video') }}
			<i class="spinner-border spinner-border-sm ml-1 mt-1" wire:loading wire:target="uploadVideo"></i>
		</button>
	</div>
</form>
```

This is our Livewire Component view, this basically will display a form with a file input and a button.

You will see the implementation in code shortly.

## Implementation in Code

Open the file `app/Http/Livewire/FileUpload.php`. Here, we are going to add a method that will handle the video selected by the user, and upload them to Cloudinary for video moderation.

Add the following code to this file.

1. First, we use Livewires `WithFileUploads` to help us with file uploads, then create the variable `$video`.
   
   ```php
   use Livewire\WithFileUploads;
   
   public $video;
   ```
2. Secondly, we will create the `uploadVideo` function which will upload the video to [Cloudinary](https://cloudinary.com). We will add the `folder`, `resource_type`, `notification_url` and `moderation` which will moderate the video.
   
   ```php
   public function uploadVideo() {
    ...
   }
   ```
3. Let's populate our method in step 2 above:

```php
public function uploadFiles() {
  /* First we validate the input from the user. We will take a video file less than 10MB in size */
	$this->validate([
	  'video' => [
	    'required',
	    'file',
	    'mimes:avi,mp4,webm,mov,ogg,mkv,flv,m3u8,ts,3gp,wmv,3g2,m4v',
	    'max:102400'
	  ],
	]);
 
  /* Upload video to Cloudinary for moderation */
	cloudinary()->upload($this->video->getRealPath(), [
	  'folder'           => 'video-mod',
	  'resource_type'    => 'video',
	  'moderation'       => 'google_video_moderation:possible',
	  'notification_url' => env('CLOUDINARY_NOTIFICATION_URL')
	]);
 
	session()->flash('message', "Video moderation initiated successfully!");
}
```

The code above performs validation then uploads the video file to Cloudinary for moderation.

On successful implementation, you should be able to see the following when you navigate to `http://localhost:8000`:

![Cloudinary Video Moderation](https://res.cloudinary.com/dgrpkngjn/image/upload/v1656844100/video-mod/assets/cloudinary_video_mod_c4akje.png)

When you successfully upload a video with questionable content you will receive two responses at the `notification_url` we have set.

First response will be the upload notification with a `pending` moderation status:

```json
{
  "notification_type": "upload",
  "timestamp": "2022-07-03T08:50:25+00:00",
  "request_id": "200c27d8d22acf7445ea1c759775bdb1",
  "asset_id": "62a5e294973044fd95df8eb1887a4db3",
  "public_id": "video-mod/PjtS3MQJUKYZzQ88GJoJMwhEkue2ND-meta5oqW6Z_zLeiusOW9lee_juWlveeUn_a0uy5tcDQ_-_crj35i",
  "version": 1656838225,
  "version_id": "fefb04a8f3cd95100600cd3d8e3bdebe",
  "width": 1280,
  "height": 720,
  "format": "mp4",
  "resource_type": "video",
	"moderation": [
		{
			"status": "pending",
			"kind": "google_video_moderation"
		}
	],
	...
}
```

The second response will be the moderation notification. This contains a bunch of data. Take note of the `moderation_status` which will let you know whether the video passed the moderation or not.

```json
{
"moderation_response": {
	"moderation_confidence": "POSSIBLE",
	"frames": [
		{
			"pornography_likelihood": "POSSIBLE",
			"time_offset": 0.769962
		},
		{
			"pornography_likelihood": "POSSIBLE",
			"time_offset": 1.891071
		},
		{
			"pornography_likelihood": "POSSIBLE",
			"time_offset": 2.730552
		},
		{
			"pornography_likelihood": "LIKELY",
			"time_offset": 3.888789
		},
		{
			"pornography_likelihood": "LIKELY",
			"time_offset": 4.755875
		},
		{
			"pornography_likelihood": "VERY_LIKELY",
			"time_offset": 5.77656
		},
		{
			"pornography_likelihood": "LIKELY",
			"time_offset": 6.650433
		},
		{
			"pornography_likelihood": "VERY_LIKELY",
			"time_offset": 7.55418
		},
		{
			"pornography_likelihood": "LIKELY",
			"time_offset": 8.730771
		}
	]
},
"moderation_status": "rejected",
"moderation_kind": "google_video_moderation",
"notification_type": "moderation",
...
}
```

You can check out the [documentation](https://cloudinary.com/documentation/google_ai_video_moderation_addon) for more details.

## Handling Cloudinary Responses

Webhooks are one of a few ways web applications can communicate with each other. We can receive Cloudinary's responses through a webhook and run processes that will do something like notify the user or ban the video.

Create a `WebhookController.php` by typing the following command:

`php artisan make:controller WebhookController`

In the file created `app/Http/Controllers/WebhookController.php` we will add the following code:

```php
public function cloudinary(Request $request) {
  //Verification
  $verified = SignatureVerifier::verifyNotificationSignature(json_encode($request), $request->header('X-Cld-Timestamp'), $request->header('X-Cld-Signature'));

  // If the signature is verified and moderation is rejected
  if ($verified && $request->moderation_status === 'rejected') {
    // Ban video
    ...
    // Notify user
		...
  }

  return response('Unverified', 401);
}
```

***Tip:*** A webhook is a mechanism where an application can notify another application that something has happened.

Since the notification from Cloudinary will be an external request we will need to allow it through the `VerifyCsrfToken.php` middleware to prevent CSRF errors.

```php
...
  protected $except = [
    'webhooks'
  ];
}
```

Next, we will create the webhook route in `routes/api.php`.

```php
...
  //webhooks client
  Route::post('webhooks/cloudinary', [WebhookController::class, 'cloudinary']);
````

And finally update our `CLOUDINARY_NOTIFICATION_URL` in the environment variables file `.env` as follows:

```php
CLOUDINARY_NOTIFICATION_URL=https://<app_url>/api/webhooks/cloudinary
```

## PHPSandbox

The final project can be viewed in the code embed below or directly on [PHPSandbox](https://phpsandbox.io/e/x/fhzst?layout=Preview&defaultPath=%2F&theme=dark&showExplorer=no&openedFiles=).

<figure style="height: 500px;"><iframe src="https://phpsandbox.io/e/x/fhzst?&layout=Preview&iframeId=ypc9hs181v&theme=dark&defaultPath=/&showExplorer=no" style="display: block" loading="lazy" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" height="100%" width="100%"></iframe></figure>

## Conclusion

Cloudinary allows you to automatically moderate all videos uploaded to your application using Google's AI Moderation. This is vital in protecting your users from explicit and suggestive adult content in videos on your website or mobile application.

Using Cloudinary's upload and delivery APIs we can have peace of mind knowing that videos uploaded on our platforms will be automatically approved for user viewing.

Check out Cloudinary for your A to Z media management - upload, storage, administration, manipulation, optimization and delivery.

[Get started](https://cloudinary.com/signup) with Cloudinary in your Laravel projects for FREE!

